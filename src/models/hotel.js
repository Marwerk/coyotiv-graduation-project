const mongoose = require('mongoose')
const autopopulate = require('mongoose-autopopulate')

const hotelSchema = new mongoose.Schema({
  name: String,
  location: String,
  rooms: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Room', autopopulate: { maxDepth: 1 } }],
  bookings: [
    { type: mongoose.Schema.Types.ObjectId, ref: 'Booking', autopopulate: { maxDepth: 1 } },
  ],
})

class Hotel {
  checkAvailability(checkIn, checkOut) {
    if (this.rooms <= 0) {
      return false
    }

    // Loop over each existing booking to check for date overlap
    for (let i = 0; i < this.bookings.length; i += 1) {
      const booking = this.bookings[i]

      // TODO: this checking of overlapping dates only makes sense if we have separate rooms, because in the current scenario
      // we have only one type of room, so while there are rooms available, we can have multiple bookings at the same time

      // check if the requested dates overlap with an existing booking
      if (checkIn < booking.checkOutDate && checkOut > booking.checkInDate) {
        return false
      }
    }

    // If there are rooms available and no overlap in dates, return true
    return true
  }

  async decreaseAvailability() {
    if (this.rooms > 0) {
      this.rooms -= 1
      await this.save()
    } else {
      console.log('All rooms are booked')
    }
  }

  async addRoom(room) {
    this.rooms.push(room)
    await this.save()
  }

  // Method to cancel booking { once we incorporate IDs generated by our DB, we can revisit this method }

  // cancelBooking(email) {
  //   const bookingToCancel = booking => booking.guest.email === email
  //   const indexOfBookingToCancel = this.bookings.findIndex(bookingToCancel)

  //   const bookingWasFound = indexOfBookingToCancel !== -1

  //   if (bookingWasFound) {
  //     this.bookings.splice(indexOfBookingToCancel, 1)
  //     this.rooms += 1
  //   }

  //   console.log(`Booking for ${email} was ${bookingWasFound ? '' : 'not '}found`)
  // }
}

// ------------------------------------------------------------------------
// module.exports = Hotel

hotelSchema.plugin(autopopulate)
hotelSchema.loadClass(Hotel)
module.exports = mongoose.model('Hotel', hotelSchema)
